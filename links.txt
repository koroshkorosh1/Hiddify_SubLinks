/**
 * Cloudflare Worker to Merge Subscription URLs
 * Author: SeRaMo ( https://github.com/seramo/ )
 */

addEventListener('fetch', (event) => {
    event.respondWith(handleRequest(event.request));
});

async function handleRequest(request) {
    const subscriptionUrls = [
        'https://raw.githubusercontent.com/m3hdio1/v2ray_sub/main/v2ray_sub.txt',
        'https://rentry.co/DailyV2ry/raw',
        'https://api.yebekhe.link/shervin',
    ];

    const responses = await Promise.all(subscriptionUrls.map(fetchAndProcessUrl));
    const mergedData = responses.filter(Boolean).join('\r\n');

    return new Response(mergedData, { status: 200 });
}

async function fetchAndProcessUrl(url) {
    try {
        const response = await fetch(url);
        if (response.ok) {
            const text = await response.text();
            return isBase64(text) ? atob(text) : text;
        }
    } catch (error) {
        console.error(`Failed to fetch ${url}: ${error}`);
    }
    return null;
}

function isBase64(str) {
    try {
        return btoa(atob(str)) === str;
    } catch (error) {
        return false;
    }
}
